# 実装方法について

弱い参照はオブジェクトの回収時機に、対象オブジェクトへの参照を切ることが出来れば良いわけです。

どうやって回収時機を捕捉するのかは、CRuby であれば `ObjectSpace::WeakMap` (1.9.3 までは `ObjectSpace.define_finalizer`) を用いていますが、mruby にはその仕組みがありません。
ですが `MRB_TT_DATA` の仕組みを使うことで、回収時機とまでは言わなくても破棄された時機を知ることが出来ます。

また、対象オブジェクトからインスタンス変数を使って捕捉オブジェクトを捕まえることで循環参照状態を作ります。
実際には mruby において対象オブジェクトがインスタンス変数を利用できるとは限らないため、特異クラスのインスタンス変数を用いています。

```
           weakref
            :   ^
            v   :
           capture <------------,
              |                 |
              v                 |
           target               |
              |                 |
              v                 |
      (singleton class)         |
              |                 |
              v                 |
(instance variable:"backref") --'
```

### WeakRef インスタンスよりも先に捕捉オブジェクトが破棄される場合

捕捉オブジェクトが破棄される時に `struct mrb_data_type` の `dfree()` 関数が呼ばれ、WeakRef インスタンスが内部的に持つ捕捉オブジェクトへのポインタを書き換えます。

捕捉オブジェクトが破棄されるということは、循環参照状態にある対象オブジェクトも破棄対象となっていることが確定的に明らかなので、対象オブジェクトから向こうに関しては何もしません。。

```
           weakref
                ^
                :
[ GC! ] -> capture <------------,
              |                 |
              v                 |
           target               |
              |                 |
              v                 |
      (singleton class)         |
              |                 |
              v                 |
(instance variable:"backref") --'
```

### 捕捉オブジェクトよりも先に WeakRef インスタンスが破棄される場合

もし WeakRef インスタンスが破棄される時に捕捉オブジェクトが生存していれば、循環参照状態にある対象オブジェクトも生存していることになる (そうでなければどっかにバグがある) ので、対象オブジェクトから辿れる逆参照を切ります。
これで捕捉オブジェクトもそのうち GC されます。

捕捉オブジェクトの生存・非生存に関わらず、捕捉オブジェクトからの WeakRef インスタンスへの逆参照を無効にします。

```
[ GC! ] -> weakref
            :
            v
           capture
              |
              v
           target
              |
              v
      (singleton class)
              |
              v
(instance variable:"backref")
```

### 最後に

最初期の実装において、capture は `MRB_TT_DATA` でしたが WeakRef の入れ物として `MRB_TT_ISTRUCT` を使っていました。

しかし、先に書いたように弱い参照オブジェクトの方が早く破棄されることがあり、`SIGSEGV` を稀によく発生させていたため、現在の `MRB_TT_DATA` を用いた実装となりました。
